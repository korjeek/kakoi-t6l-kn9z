<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Простой конструктор тестов с мультиселектором</title>
  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="../static/css/creator.css">
  <style>
    /* ========== Стили для мультиселектора ========== */
    .multi-dropdown {
      position: relative;
      width: 100%;
    }
    .multi-dropdown__button {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      cursor: pointer;
      box-sizing: border-box;
    }
    .multi-dropdown__button:hover {
      border-color: #888;
    }
    .multi-dropdown__selected {
      flex-grow: 1;
      font-size: 14px;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .multi-dropdown__search {
      display: none;
      width: 100%;
      padding: 4px 8px;
      margin-top: 4px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .multi-dropdown__arrow {
      margin-left: 8px;
      font-size: 12px;
      color: #555;
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }
    .multi-dropdown__arrow.open {
      transform: rotate(90deg);
    }
    .multi-dropdown__list {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      background-color: #fff;
      border: 1px solid #aaa;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      z-index: 10;
      display: none;
      box-sizing: border-box;
    }
    .multi-dropdown__item {
      display: flex;
      align-items: center;
      padding: 6px 10px;
      cursor: pointer;
      user-select: none;
    }
    .multi-dropdown__item:hover {
      background-color: #f5f5f5;
    }
    .multi-dropdown__item.selected {
      background-color: #e0f0ff;
    }
    .multi-dropdown__item .checkmark {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      border: 1px solid #888;
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #007acc;
      visibility: hidden;
    }
    .multi-dropdown__item.selected .checkmark {
      visibility: visible;
    }
    .multi-dropdown__item .item-label {
      flex-grow: 1;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
<nav>
  <div class="nav-container">
    <a href="/" class="logo">🧩 GGTests</a>
    <div class="nav-links">
      <a href="/index">Главная</a>
      <a href="/test-creator" aria-current="page">Создать тест</a>
    </div>
  </div>
</nav>

<main class="creator-container">
  <section class="section">
    <h1 class="creator-title">Создание теста</h1>
    <input type="text" id="testTitle" class="form-input" placeholder="Название теста">
  </section>

  <section class="section">
    <h2 class="section-title">Обложка теста</h2>
    <div class="image-upload">
      <label class="file-upload">
        <input type="file" id="mainImage" accept="image/*">
      </label>
    </div>
  </section>

  <section class="section">
    <div class="section-header">
      <h2 class="section-title">Характеристики</h2>
    </div>
    <div id="traits" class="traits-list"></div>
    <button class="btn btn-icon add-bottom-btn" onclick="addTrait()">
      <span>+</span> Добавить характеристику
    </button>
  </section>

  <section class="section">
    <div class="section-header">
      <h2 class="section-title">Вопросы</h2>
    </div>
    <div id="questions" class="questions-list"></div>
    <button class="btn btn-icon add-bottom-btn" onclick="addQuestion()">
      <span>+</span> Добавить вопрос
    </button>
  </section>

  <div class="actions">
    <button class="btn btn-primary btn-lg" onclick="saveTest()">💾 Сохранить тест</button>
    <div id="error-messages" class="error-message"></div>
  </div>
</main>

<script>
  let traitsList = [];
  let mainImageBase64 = '';

  // Обработка изображения
  document.getElementById('mainImage').addEventListener('change', function(e) {
    handleImageUpload(e.target);
  });

  function handleImageUpload(input) {
    const file = input.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
      showError('Пожалуйста, выберите изображение!');
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      const container = input.closest('.image-upload');
      let previewContainer = container.querySelector('.image-preview-container');
      if (!previewContainer) {
        previewContainer = document.createElement('div');
        previewContainer.className = 'image-preview-container';
        container.appendChild(previewContainer);
      }
      let preview = previewContainer.querySelector('.image-preview');
      if (!preview) {
        preview = document.createElement('img');
        preview.className = 'image-preview';
        previewContainer.appendChild(preview);
      }
      preview.src = e.target.result;
      preview.style.display = 'block';
      if (input.id === 'mainImage') {
        mainImageBase64 = e.target.result;
      }
      addRemoveButton(previewContainer, input);
    };
    reader.readAsDataURL(file);
  }

  function addRemoveButton(container, input) {
    const existing = container.querySelector('.remove-image');
    if (existing) existing.remove();
    const btn = document.createElement('button');
    btn.className = 'remove-image';
    btn.innerHTML = `
      <svg viewBox="0 0 24 24" width="18" height="18">
        <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 
          6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 
          13.41 17.59 19 19 17.59 13.41 12z"/>
      </svg>`;
    btn.onclick = () => {
      input.value = '';
      container.remove();
      if (input.id === 'mainImage') mainImageBase64 = '';
    };
    container.appendChild(btn);
  }

  function updateTraitOptions() {
    traitsList = Array.from(document.querySelectorAll('.trait-name'))
            .map(input => input.value.trim()).filter(name => name);
    const unique = [...new Set(traitsList)];
    if (unique.length !== traitsList.length) {
      showError('Характеристики должны быть уникальными!');
      return;
    }
    // Перерисовать каждую мультиселект-обёртку
    document.querySelectorAll('.multi-dropdown').forEach(dd => {
      refreshMultiDropdown(dd);
    });
  }

  function addTrait() {
    const traitsDiv = document.getElementById('traits');
    const newTrait = document.createElement('div');
    newTrait.className = 'trait';
    newTrait.innerHTML = `
      <input type="text" placeholder="Имя характеристики" class="trait-name form-input">
      <button class="btn btn-danger" onclick="removeElement(this)">
        <span>×</span> Удалить
      </button>`;
    traitsDiv.appendChild(newTrait);
    const inp = newTrait.querySelector('.trait-name');
    inp.addEventListener('input', () => {
      clearTimeout(inp.timeout);
      inp.timeout = setTimeout(updateTraitOptions, 300);
    });
    updateTraitOptions();
  }

  function addQuestion() {
    const questionsDiv = document.getElementById('questions');
    const newQ = document.createElement('div');
    newQ.className = 'question';
    newQ.innerHTML = `
      <div class="image-upload">
        <label class="file-upload">
          <input type="file" class="question-image" accept="image/*">
        </label>
      </div>
      <input type="text" placeholder="Текст вопроса" class="question-text form-input">
      <div class="answers">
        <div class="answer">
          <input type="text" placeholder="Ответ" class="answer-text form-input">
          <div class="multi-dropdown answer-dropdown"></div>
        </div>
      </div>
      <div class="answer-actions">
        <button class="btn btn-icon" onclick="addAnswer(this)">
          <span>+</span> Ответ
        </button>
        <button class="btn btn-danger" onclick="removeElement(this)">
          <span>×</span> Удалить вопрос
        </button>
      </div>`;
    const imgInp = newQ.querySelector('.question-image');
    imgInp.addEventListener('change', e => handleImageUpload(e.target));
    questionsDiv.appendChild(newQ);
    // Создать мультиселектор для первого ответа
    const ddContainer = newQ.querySelector('.answer-dropdown');
    createMultiDropdown(ddContainer);
    updateTraitOptions();
  }

  function addAnswer(btn) {
    const answersDiv = btn.parentElement.previousElementSibling;
    const newAns = document.createElement('div');
    newAns.className = 'answer';
    newAns.innerHTML = `
      <input type="text" placeholder="Ответ" class="answer-text form-input">
      <div class="multi-dropdown answer-dropdown"></div>
      <button class="btn btn-danger" onclick="removeElement(this)">
        <span>×</span> Удалить ответ
      </button>`;
    answersDiv.appendChild(newAns);
    const ddContainer = newAns.querySelector('.answer-dropdown');
    createMultiDropdown(ddContainer);
    updateTraitOptions();
  }

  function removeElement(btn) {
    const el = btn.closest('.trait, .question, .answer');
    if (el) {
      el.remove();
      updateTraitOptions();
    }
  }

  function saveTest() {
    const errDiv = document.getElementById('error-messages');
    errDiv.innerHTML = '';

    const title = document.getElementById('testTitle').value;
    if (!title) return showError('Введите название теста!');
    if (traitsList.length < 2) return showError('Добавьте минимум 2 характеристики!');

    const questions = Array.from(document.querySelectorAll('.question'));
    if (!questions.length) return showError('Добавьте минимум 1 вопрос!');

    const testData = {
      title,
      mainImage: mainImageBase64,
      traits: traitsList,
      questions: []
    };

    questions.forEach(qEl => {
      const qObj = {
        text: qEl.querySelector('.question-text').value,
        image: (qEl.querySelector('.image-preview')?.src || ''),
        answers: []
      };
      const answers = qEl.querySelectorAll('.answer');
      answers.forEach(ansEl => {
        const ansText = ansEl.querySelector('.answer-text').value;
        if (!ansText) return showError('Заполните все ответы!');
        // Получаем выбранные теги из мультиселектора
        const ddEl = ansEl.querySelector('.multi-dropdown');
        const chosen = Array.from(ddEl.querySelectorAll('.multi-dropdown__item.selected'))
                .map(it => it.getAttribute('data-value'));
        if (!chosen.length) return showError('Для всех ответов выберите хотя бы одну характеристику!');
        qObj.answers.push({ text: ansText, trait: chosen });
      });
      testData.questions.push(qObj);
    });

    // localStorage.setItem('currentTest', JSON.stringify(testData));
    
    
    window.location.href = '/test-runner';
  }

  function showError(msg) {
    const ed = document.getElementById('error-messages');
    ed.innerHTML = msg;
    throw new Error(msg);
  }

  // =========================
  // Реализация мульти-дропдауна
  // =========================
  function createMultiDropdown(container) {
    container.innerHTML = '';

    const wrapper = document.createElement('div');
    wrapper.className = 'multi-dropdown';
    // Храним выбранные теги в этом объекте
    wrapper._selectedTags = [];

    const button = document.createElement('div');
    button.className = 'multi-dropdown__button';
    button.tabIndex = 0;

    const selectedDisplay = document.createElement('span');
    selectedDisplay.className = 'multi-dropdown__selected';
    selectedDisplay.textContent = 'Выберите характеристику';

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Поиск...';
    searchInput.className = 'multi-dropdown__search';

    const arrow = document.createElement('span');
    arrow.className = 'multi-dropdown__arrow';
    arrow.innerHTML = '&#9654;';

    button.appendChild(selectedDisplay);
    button.appendChild(searchInput);
    button.appendChild(arrow);

    const list = document.createElement('div');
    list.className = 'multi-dropdown__list';

    wrapper.appendChild(button);
    wrapper.appendChild(list);
    container.appendChild(wrapper);

    // Напишем populateList как метод для этого wrapper
    wrapper._populateList = () => {
      list.innerHTML = '';
      const filter = searchInput.value.trim().toLowerCase();
      const toShow = traitsList.filter(tag => tag.toLowerCase().includes(filter));
      toShow.forEach(tag => {
        const item = document.createElement('div');
        item.className = 'multi-dropdown__item';
        item.setAttribute('data-value', tag);

        const checkmark = document.createElement('span');
        checkmark.className = 'checkmark';
        checkmark.textContent = '✔';
        item.appendChild(checkmark);

        const label = document.createElement('span');
        label.className = 'item-label';
        label.textContent = tag;
        item.appendChild(label);

        if (wrapper._selectedTags.includes(tag)) {
          item.classList.add('selected');
        }

        item.addEventListener('click', e => {
          e.stopPropagation();
          if (item.classList.contains('selected')) {
            item.classList.remove('selected');
            wrapper._selectedTags = wrapper._selectedTags.filter(t => t !== tag);
          } else {
            item.classList.add('selected');
            wrapper._selectedTags.push(tag);
          }
          updateButtonText();
        });

        list.appendChild(item);
      });
    };

    function updateButtonText() {
      const chosen = wrapper._selectedTags;
      if (!chosen.length) {
        selectedDisplay.textContent = 'Выберите характеристику';
      } else {
        selectedDisplay.textContent = chosen.join(', ');
      }
    }

    function toggleDropdown() {
      const isOpen = list.style.display === 'block';
      if (isOpen) {
        list.style.display = 'none';
        searchInput.style.display = 'none';
        arrow.classList.remove('open');
        selectedDisplay.style.display = 'inline';
        searchInput.value = '';
      } else {
        list.style.display = 'block';
        searchInput.style.display = 'block';
        arrow.classList.add('open');
        selectedDisplay.style.display = 'none';
        searchInput.focus();
        wrapper._populateList();
      }
    }

    button.addEventListener('click', e => {
      e.stopPropagation();
      toggleDropdown();
    });
    button.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleDropdown();
      }
    });
    searchInput.addEventListener('input', wrapper._populateList);
    document.addEventListener('click', () => {
      if (list.style.display === 'block') toggleDropdown();
    });

    // Инициализировать
    updateButtonText();
    wrapper._populateList();
  }

  function refreshMultiDropdown(container) {
    // container может быть либо обёртка `.multi-dropdown`, либо обёртка внешнего div
    let wrapper = container;
    if (!wrapper.classList.contains('multi-dropdown')) {
      wrapper = container.querySelector('.multi-dropdown');
    }
    if (!wrapper) return;
    // если открыт, обновляем фильтрованный список
    const list = wrapper.querySelector('.multi-dropdown__list');
    const searchInput = wrapper.querySelector('.multi-dropdown__search');
    if (list.style.display === 'block') {
      wrapper._populateList();
    }
  }
</script>
</body>
</html>
